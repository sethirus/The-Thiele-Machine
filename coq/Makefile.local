# Custom targets introduced by the November 2025 audit.
# They keep the autogenerated Makefile untouched while providing
# tier-aware build shortcuts.

CORE_VO := \
  kernel/Kernel.vo \
  kernel/KernelTM.vo \
  kernel/KernelThiele.vo \
  kernel/VMState.vo \
  kernel/VMStep.vo \
  kernel/VMEncoding.vo \
  kernel/SimulationProof.vo \
  kernel/MuLedgerConservation.vo \
  kernel/Subsumption.vo \
  modular_proofs/CornerstoneThiele.vo \
  modular_proofs/Encoding.vo \
  modular_proofs/EncodingBounds.vo \
  modular_proofs/Minsky.vo \
  modular_proofs/Simulation.vo \
  modular_proofs/TM_Basics.vo \
  modular_proofs/Thiele_Basics.vo \
  thielemachine/coqproofs/AmortizedAnalysis.vo \
  thielemachine/coqproofs/Axioms.vo \
  thielemachine/coqproofs/BellInequality.vo \
  thielemachine/coqproofs/BellCheck.vo \
  thielemachine/coqproofs/LawCheck.vo \
  thielemachine/coqproofs/PhaseThree.vo \
  thielemachine/coqproofs/Bisimulation.vo \
  thielemachine/coqproofs/Confluence.vo \
  thielemachine/coqproofs/EncodingBridge.vo \
  thielemachine/coqproofs/ListHelpers.vo \
  thielemachine/coqproofs/NUSD.vo \
  thielemachine/coqproofs/PartitionLogic.vo \
  thielemachine/coqproofs/Oracle.vo \
  thielemachine/coqproofs/QHelpers.vo \
  thielemachine/coqproofs/Separation.vo \
  thielemachine/coqproofs/SpecSound.vo \
  thielemachine/coqproofs/StructuredInstances.vo \
  thielemachine/coqproofs/HardwareBridge.vo \
  thielemachine/coqproofs/ThieleProc.vo \
  thielemachine/coqproofs/HyperThiele_Oracle.vo \
  thielemachine/coqproofs/HyperThiele_Halting.vo \
  thielemachine/coqproofs/ThieleMachine.vo \
  thielemachine/coqproofs/ThieleMachineConcrete.vo \
  thielemachine/coqproofs/ThieleMachineConcretePack.vo \
  thielemachine/coqproofs/ThieleMachineModular.vo \
  thielemachine/coqproofs/ThieleMachineUniv.vo \
  thielemachine/coqproofs/UTMStaticCheck.vo

BRIDGE_VO := \
  thielemachine/verification/ThieleUniversalBridge.vo \
  thieleuniversal/coqproofs/ThieleUniversal.vo

# Default timeout (in seconds) when profiling the bridge build.
# CI can override this via `BRIDGE_TIMEOUT=900 make bridge-timed`.
BRIDGE_TIMEOUT ?= 300

OPTIONAL_VO := \
  catnet/coqproofs/CatNet.vo \
  physics/DiscreteModel.vo \
  physics/DissipativeModel.vo \
  physics/WaveModel.vo \
  isomorphism/coqproofs/Universe.vo \
  project_cerberus/coqproofs/Cerberus.vo \
  shor_primitives/Euclidean.vo \
  shor_primitives/Modular.vo \
  shor_primitives/PeriodFinding.vo \
  self_reference/SelfReference.vo \
  spacetime/Spacetime.vo \
  thiele_manifold/ThieleManifold.vo \
  thiele_manifold/ThieleManifoldBridge.vo \
  thiele_manifold/PhysicalConstants.vo \
  thiele_manifold/PhysicsIsomorphism.vo \
  thielemachine/coqproofs/PhysicsEmbedding.vo \
  thielemachine/coqproofs/DissipativeEmbedding.vo \
  thielemachine/coqproofs/WaveEmbedding.vo \
  thielemachine/coqproofs/HardwareVMHarness.vo \
  spacetime_projection/SpacetimeProjection.vo \
  test_vscoq/coqproofs/test_vscoq.vo

ORACLE_VO := \
  thielemachine/coqproofs/HyperThiele_Oracle.vo \
  thielemachine/coqproofs/HyperThiele_Halting.vo

.PHONY: core bridge optional oracle verification

.DEFAULT_GOAL := core

core:
	$(MAKE) $(CORE_VO)

bridge:
	$(MAKE) $(BRIDGE_VO)

# Run the bridge with a wall-clock timeout so long symbolic-execution
# runs produce a clear failure signal instead of hanging CI logs.
bridge-timed:
	timeout $(BRIDGE_TIMEOUT) $(MAKE) bridge ; \
	status=$$? ; \
	if [ $$status -eq 124 ]; then \
	  echo "[bridge-timed] timed out after $(BRIDGE_TIMEOUT)s" ; \
	  exit 124 ; \
	else \
	  exit $$status ; \
	fi

verification: bridge

optional:
	$(MAKE) $(OPTIONAL_VO)

oracle:
	$(MAKE) $(ORACLE_VO)
