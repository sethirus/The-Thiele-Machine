# Custom targets introduced by the November 2025 audit.
# They keep the autogenerated Makefile untouched while providing
# tier-aware build shortcuts.

CORE_FAST_VO := \
  kernel/Kernel.vo \
  kernel/KernelTM.vo \
  kernel/KernelThiele.vo \
  kernel/VMState.vo \
  kernel/VMStep.vo \
  kernel/VMEncoding.vo \
  kernel/SimulationProof.vo \
  kernel/MuLedgerConservation.vo \
  kernel/Subsumption.vo \
  modular_proofs/CornerstoneThiele.vo \
  modular_proofs/Encoding.vo \
  modular_proofs/EncodingBounds.vo \
  modular_proofs/Minsky.vo \
  modular_proofs/Simulation.vo \
  modular_proofs/TM_Basics.vo \
  modular_proofs/Thiele_Basics.vo \
  thielemachine/coqproofs/AmortizedAnalysis.vo \
  thielemachine/coqproofs/Axioms.vo \
  thielemachine/coqproofs/BellInequality.vo \
  thielemachine/coqproofs/BellCheck.vo \
  thielemachine/coqproofs/LawCheck.vo \
  thielemachine/coqproofs/PhaseThree.vo \
  thielemachine/coqproofs/Bisimulation.vo \
  thielemachine/coqproofs/Confluence.vo \
  thielemachine/coqproofs/EncodingBridge.vo \
  thielemachine/coqproofs/ListHelpers.vo \
  thielemachine/coqproofs/NUSD.vo \
  thielemachine/coqproofs/PartitionLogic.vo \
  thielemachine/coqproofs/Oracle.vo \
  thielemachine/coqproofs/QHelpers.vo \
  thielemachine/coqproofs/Separation.vo \
  thielemachine/coqproofs/SpecSound.vo \
  thielemachine/coqproofs/StructuredInstances.vo \
  thielemachine/coqproofs/HardwareBridge.vo \
  thielemachine/coqproofs/ThieleProc.vo \
  thielemachine/coqproofs/HyperThiele_Oracle.vo \
  thielemachine/coqproofs/HyperThiele_Halting.vo \
  thielemachine/coqproofs/ThieleMachine.vo \
  thielemachine/coqproofs/ThieleMachineConcrete.vo \
  thielemachine/coqproofs/ThieleMachineConcretePack.vo \
  thielemachine/coqproofs/ThieleMachineModular.vo \
  thielemachine/coqproofs/ThieleMachineUniv.vo \
  thielemachine/coqproofs/UTMStaticCheck.vo

BRIDGE_VO := \
  thielemachine/verification/ThieleUniversalBridge.vo \
  thieleuniversal/coqproofs/ThieleUniversal.vo

# Default timeout (in seconds) when profiling the bridge build.
# CI can override this via `BRIDGE_TIMEOUT=900 make bridge-timed`.
BRIDGE_TIMEOUT ?= 300

OPTIONAL_VO := \
  catnet/coqproofs/CatNet.vo \
  Extraction.vo \
  physics/DiscreteModel.vo \
  physics/DissipativeModel.vo \
  physics/WaveModel.vo \
  isomorphism/coqproofs/Universe.vo \
  project_cerberus/coqproofs/Cerberus.vo \
  shor_primitives/Euclidean.vo \
  shor_primitives/Modular.vo \
  shor_primitives/PeriodFinding.vo \
  self_reference/SelfReference.vo \
  spacetime/Spacetime.vo \
  thiele_manifold/ThieleManifold.vo \
  thiele_manifold/ThieleManifoldBridge.vo \
  thiele_manifold/PhysicalConstants.vo \
  thiele_manifold/PhysicsIsomorphism.vo \
  thielemachine/coqproofs/PhysicsEmbedding.vo \
  thielemachine/coqproofs/DissipativeEmbedding.vo \
  thielemachine/coqproofs/WaveEmbedding.vo \
  thielemachine/coqproofs/HardwareVMHarness.vo \
  thielemachine/coqproofs/AmortizedAnalysis.vo \
  thielemachine/coqproofs/Subsumption.vo \
  thielemachine/coqproofs/WaveCheck.vo \
  thielemachine/coqproofs/Confluence.vo \
  thielemachine/coqproofs/SpecSound.vo \
  thielemachine/coqproofs/StructuredInstances.vo \
  thielemachine/coqproofs/ThieleFoundations.vo \
  thielemachine/coqproofs/PartitionDiscoveryIsomorphism.vo \
  thielemachine/coqproofs/OracleImpossibility.vo \
  thielemachine/coqproofs/DiscoveryProof.vo \
  thielemachine/coqproofs/RepresentationTheorem.vo \
  thielemachine/coqproofs/MuAlignmentExample.vo \
  spacetime_projection/SpacetimeProjection.vo \
  test_vscoq/coqproofs/test_vscoq.vo

ORACLE_VO := \
  thielemachine/coqproofs/HyperThiele_Oracle.vo \
  thielemachine/coqproofs/HyperThiele_Halting.vo

.PHONY: all-proofs core core-fast bridge optional oracle verification

# Canonical build: compile *everything* listed in `_CoqProject`.
#
# `coq_makefile` already provides an `all` target that builds all `.vo`s from
# `VFILES`. We set that as the default to ensure one-command reproducibility
# with no tiering/exceptions.
.DEFAULT_GOAL := all

# Back-compat alias: historically we used `make core`.
core: all

all-proofs: all

core-fast:
	$(MAKE) $(CORE_FAST_VO)

bridge:
	$(MAKE) $(BRIDGE_VO)

# Run the bridge with a wall-clock timeout so long symbolic-execution
# runs produce a clear failure signal instead of hanging CI logs.
bridge-timed:
	timeout $(BRIDGE_TIMEOUT) $(MAKE) bridge ; \
	status=$$? ; \
	if [ $$status -eq 124 ]; then \
	  echo "[bridge-timed] timed out after $(BRIDGE_TIMEOUT)s" ; \
	  exit 124 ; \
	else \
	  exit $$status ; \
	fi

verification: bridge

optional:
	$(MAKE) $(OPTIONAL_VO)

oracle:
	$(MAKE) $(ORACLE_VO)

# Coq loadpath hygiene
#
# coq_makefile injects `-R . Top` by default, which overlaps with the explicit
# `-Q thielemachine/coqproofs ThieleMachine` mapping and can cause Coq to
# remap `ThieleMachine.*` libraries into `Top.*`. Strip that implicit mapping
# so the intended logical roots remain stable.
COQLIBS := $(subst -R . Top,,$(COQLIBS))
CMDLINE_COQLIBS := $(subst -R . Top,,$(CMDLINE_COQLIBS))
