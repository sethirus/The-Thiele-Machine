name: Adversarial Audit - Zero Tolerance

on:
  push:
    branches: [ main, master, develop, claude/** ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  zero-admits-axioms:
    name: "ENFORCE: Zero Admits & Axioms"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Coq
        run: |
          sudo apt-get update
          sudo apt-get install -y coq coinor-csdp

      - name: "CRITICAL: Search for ANY admits in kernel"
        run: |
          echo "üîç Searching for Admitted proofs in ALL kernel files..."
          ADMITS=$(find coq/kernel -name "*.v" -exec grep -l "Admitted\." {} \; 2>/dev/null || true)

          if [ -n "$ADMITS" ]; then
            echo "‚ùå CRITICAL FAILURE: Found Admitted proofs in kernel:"
            echo "$ADMITS"
            echo ""
            echo "Admitted proofs are FORBIDDEN in kernel. All proofs must be complete."
            exit 1
          fi

          echo "‚úÖ PASSED: Zero admits found in kernel"

      - name: "CRITICAL: Search for ANY global axioms"
        run: |
          echo "üîç Searching for global Axiom declarations..."

          # Search for Axiom/Parameter outside Module Type
          AXIOMS=$(find coq/kernel -name "*.v" -exec sh -c '
            grep -n "^Axiom \|^Parameter " "$1" | while read line; do
              # Check if this is inside a Module Type
              linenum=$(echo "$line" | cut -d: -f1)
              if ! awk -v ln="$linenum" "NR<ln && /Module Type/ {found=1} NR==ln && found {exit 1}" "$1"; then
                echo "$1:$line"
              fi
            done
          ' _ {} \; 2>/dev/null || true)

          if [ -n "$AXIOMS" ]; then
            echo "‚ùå CRITICAL FAILURE: Found global axioms in kernel:"
            echo "$AXIOMS"
            echo ""
            echo "Global axioms are FORBIDDEN. Only Module Type parameters are allowed."
            exit 1
          fi

          echo "‚úÖ PASSED: Zero global axioms found"

      - name: "CRITICAL: Check for admit tactics"
        run: |
          echo "üîç Searching for admit tactics in proofs..."
          ADMIT_TACTICS=$(find coq/kernel -name "*.v" -exec grep -n " admit\." {} + 2>/dev/null | grep -v "^[^:]*:[^:]*:(\\*.*admit" || true)

          if [ -n "$ADMIT_TACTICS" ]; then
            echo "‚ùå CRITICAL FAILURE: Found 'admit.' tactic in kernel:"
            echo "$ADMIT_TACTICS"
            exit 1
          fi

          echo "‚úÖ PASSED: No admit tactics found"

      - name: "Run official audit script"
        run: |
          bash scripts/audit_coq_proofs.sh > /tmp/audit_result.txt 2>&1
          cat /tmp/audit_result.txt

          # Check for failures
          if grep -q "Admitted proofs:" /tmp/audit_result.txt; then
            ADMIT_COUNT=$(grep "Admitted proofs:" /tmp/audit_result.txt | grep -oP '\d+')
            if [ "$ADMIT_COUNT" != "0" ]; then
              echo "‚ùå AUDIT FAILED: Found $ADMIT_COUNT admits"
              exit 1
            fi
          fi

          if grep -q "Axioms declared:" /tmp/audit_result.txt; then
            AXIOM_COUNT=$(grep "Axioms declared:" /tmp/audit_result.txt | grep -oP '\d+')
            if [ "$AXIOM_COUNT" != "0" ]; then
              echo "‚ùå AUDIT FAILED: Found $AXIOM_COUNT axioms"
              exit 1
            fi
          fi

          echo "‚úÖ AUDIT PASSED"

  coq-kernel-build:
    name: "ENFORCE: Full Coq Kernel Compilation"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Coq and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coq coinor-csdp

      - name: "Build critical kernel files"
        run: |
          cd coq
          echo "üî® Building key kernel proofs..."

          # Regenerate Makefile from _CoqProject
          coq_makefile -f _CoqProject -o Makefile 2>&1 | grep -v "Warning:" || true

          # Build key theorems (fast check)
          make kernel/Subsumption.vo || { echo "‚ùå Subsumption.vo failed"; exit 1; }
          make kernel/NoFreeInsight.vo || { echo "‚ùå NoFreeInsight.vo failed"; exit 1; }
          make kernel/MuLedgerConservation.vo || { echo "‚ùå MuLedgerConservation.vo failed"; exit 1; }
          make kernel/ValidCorrelation.vo || { echo "‚ùå ValidCorrelation.vo failed"; exit 1; }
          make kernel/AlgebraicCoherence.vo || { echo "‚ùå AlgebraicCoherence.vo failed"; exit 1; }
          make kernel/BoxCHSH.vo || { echo "‚ùå BoxCHSH.vo failed"; exit 1; }
          make kernel/TestTripartite.vo || { echo "‚ùå TestTripartite.vo failed"; exit 1; }
          make kernel/TsirelsonUniqueness.vo || { echo "‚ùå TsirelsonUniqueness.vo failed"; exit 1; }
          make kernel/TsirelsonUpperBound.vo || { echo "‚ùå TsirelsonUpperBound.vo failed"; exit 1; }
          make kernel/NonCircularityAudit.vo || { echo "‚ùå NonCircularityAudit.vo failed"; exit 1; }

          echo "‚úÖ All critical kernel files compiled successfully"

      - name: "Verify _CoqProject includes BoxCHSH.v"
        run: |
          if ! grep -q "kernel/BoxCHSH.v" coq/_CoqProject; then
            echo "‚ùå CRITICAL: BoxCHSH.v missing from _CoqProject"
            echo "This was a bug found during adversarial audit."
            exit 1
          fi
          echo "‚úÖ BoxCHSH.v is in _CoqProject"

  circular-reasoning-check:
    name: "ENFORCE: No Circular Reasoning"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: "Check primitives don't encode Tsirelson bound"
        run: |
          echo "üîç Checking that primitives are physics-free..."

          # Check VMState, VMStep, MuCostModel don't reference Tsirelson/2‚àö2
          TSIRELSON_REFS=$(grep -n "2828\|sqrt.*2\|Tsirelson\|2\.828\|2‚àö2" \
            coq/kernel/VMState.v \
            coq/kernel/VMStep.v \
            coq/kernel/MuCostModel.v \
            2>/dev/null | grep -v "NO REFERENCE\|This is NOT assumed" || true)

          if [ -n "$TSIRELSON_REFS" ]; then
            echo "‚ùå CRITICAL: Found Tsirelson references in primitives:"
            echo "$TSIRELSON_REFS"
            echo ""
            echo "Primitives must be physics-free. Tsirelson bound should be DERIVED, not assumed."
            exit 1
          fi

          echo "‚úÖ PASSED: Primitives are physics-free"

      - name: "Check dependency graph for cycles"
        run: |
          echo "üîç Checking for circular imports in key theorems..."

          # Check if Subsumption, NoFreeInsight, MuLedgerConservation import each other circularly
          if grep -q "Require.*NoFreeInsight" coq/kernel/Subsumption.v && \
             grep -q "Require.*Subsumption" coq/kernel/NoFreeInsight.v; then
            echo "‚ùå CIRCULAR IMPORT: Subsumption ‚Üî NoFreeInsight"
            exit 1
          fi

          if grep -q "Require.*MuLedgerConservation" coq/kernel/Subsumption.v && \
             grep -q "Require.*Subsumption" coq/kernel/MuLedgerConservation.v; then
            echo "‚ùå CIRCULAR IMPORT: Subsumption ‚Üî MuLedgerConservation"
            exit 1
          fi

          if grep -q "Require.*NoFreeInsight" coq/kernel/MuLedgerConservation.v && \
             grep -q "Require.*MuLedgerConservation" coq/kernel/NoFreeInsight.v; then
            echo "‚ùå CIRCULAR IMPORT: MuLedgerConservation ‚Üî NoFreeInsight"
            exit 1
          fi

          echo "‚úÖ PASSED: No circular dependencies detected"

  hardware-synthesis:
    name: "ENFORCE: Hardware Synthesizes"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Yosys and iverilog
        run: |
          sudo apt-get update
          sudo apt-get install -y yosys iverilog

      - name: "Synthesize Œº-ALU with Yosys"
        run: |
          echo "üî® Synthesizing Œº-ALU hardware..."

          yosys -p "read_verilog thielecpu/hardware/mu_alu.v; hierarchy -check; proc; opt; stat" \
            > /tmp/yosys_synth.log 2>&1

          # Check for errors
          if grep -qi "error" /tmp/yosys_synth.log; then
            echo "‚ùå SYNTHESIS FAILED"
            cat /tmp/yosys_synth.log
            exit 1
          fi

          # Verify synthesis produced cells
          CELL_COUNT=$(grep "Number of cells:" /tmp/yosys_synth.log | grep -oP '\d+' || echo "0")
          if [ "$CELL_COUNT" -lt "500" ]; then
            echo "‚ùå Synthesis produced only $CELL_COUNT cells (expected ~555)"
            exit 1
          fi

          echo "‚úÖ PASSED: Œº-ALU synthesized successfully ($CELL_COUNT cells)"

      - name: "Compile with iverilog"
        run: |
          echo "üî® Compiling Verilog with iverilog..."
          iverilog -o /tmp/thiele_cpu thielecpu/hardware/mu_alu.v

          if [ $? -ne 0 ]; then
            echo "‚ùå iverilog compilation failed"
            exit 1
          fi

          echo "‚úÖ PASSED: Verilog compiles with iverilog"

      - name: "Verify Œº-accumulator has no subtraction"
        run: |
          echo "üîç Checking Œº-accumulator is monotonic..."

          # Check for subtract operations on mu_accumulator
          MU_SUB=$(grep -n "mu_acc.*-\|mu.*sub" thielecpu/hardware/mu_alu.v || true)

          if [ -n "$MU_SUB" ]; then
            echo "‚ùå CRITICAL: Found subtraction on Œº-accumulator:"
            echo "$MU_SUB"
            echo "Œº-accumulator must be monotonically increasing (Œº-conservation)"
            exit 1
          fi

          echo "‚úÖ PASSED: Œº-accumulator is monotonic"

  mu-conservation-check:
    name: "ENFORCE: Œº-Conservation"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Coq
        run: |
          sudo apt-get update
          sudo apt-get install -y coq coinor-csdp

      - name: "Verify MuLedgerConservation.v compiles"
        run: |
          cd coq
          coq_makefile -f _CoqProject -o Makefile 2>&1 | grep -v "Warning:" || true
          make kernel/MuLedgerConservation.vo

          echo "‚úÖ Œº-conservation theorem compiles"

      - name: "Check for negative instruction costs"
        run: |
          echo "üîç Checking all instruction costs are non-negative..."

          NEG_COSTS=$(grep -n "instruction_cost.*:=.*-\|instruction_cost.*<\s*0" \
            coq/kernel/VMStep.v coq/kernel/MuCostModel.v 2>/dev/null || true)

          if [ -n "$NEG_COSTS" ]; then
            echo "‚ùå CRITICAL: Found negative instruction costs:"
            echo "$NEG_COSTS"
            echo "All costs must be non-negative for Œº-conservation"
            exit 1
          fi

          echo "‚úÖ PASSED: All instruction costs are non-negative"

  inquisitor-strict:
    name: "ENFORCE: Inquisitor Quality Standards"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Inquisitor in strict mode
        run: |
          python scripts/inquisitor.py --report /tmp/inquisitor.md 2>&1 | tee /tmp/inquisitor.log

          # Extract HIGH issue count
          HIGH_COUNT=$(grep "^- HIGH:" /tmp/inquisitor.md | grep -oP '\d+' || echo "0")

          if [ "$HIGH_COUNT" -gt "0" ]; then
            echo "‚ùå CRITICAL: Found $HIGH_COUNT HIGH-severity issues"
            cat /tmp/inquisitor.md
            exit 1
          fi

          echo "‚úÖ PASSED: Zero HIGH-severity issues"

      - name: Upload Inquisitor Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: inquisitor-adversarial-report
          path: /tmp/inquisitor.md

  proof-chain-verification:
    name: "ENFORCE: Proof Chain Integrity"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Coq
        run: |
          sudo apt-get update
          sudo apt-get install -y coq coinor-csdp

      - name: "Verify short proofs delegate to real proofs"
        run: |
          cd coq

          echo "üîç Checking proof delegation chains..."

          # Check mu_zero_algebraic_bound delegates to mu_zero_chsh_bounded
          if ! grep -q "apply mu_zero_chsh_bounded" kernel/TsirelsonUniqueness.v; then
            echo "‚ùå Proof delegation broken in TsirelsonUniqueness.v"
            exit 1
          fi

          # Check mu_zero_chsh_bounded delegates to chsh_algebraic_bound
          if ! grep -q "apply chsh_algebraic_bound" kernel/TsirelsonUpperBound.v; then
            echo "‚ùå Proof delegation broken in TsirelsonUpperBound.v"
            exit 1
          fi

          # Check chsh_algebraic_bound has substantial proof
          PROOF_SIZE=$(awk '/^Lemma chsh_algebraic_bound/,/^Qed\./' kernel/CHSHExtraction.v | wc -l)
          if [ "$PROOF_SIZE" -lt "10" ]; then
            echo "‚ùå chsh_algebraic_bound proof is too short ($PROOF_SIZE lines)"
            exit 1
          fi

          echo "‚úÖ PASSED: Proof chains verified"

  adversarial-summary:
    name: "üìä Adversarial Audit Summary"
    runs-on: ubuntu-latest
    needs: [zero-admits-axioms, coq-kernel-build, circular-reasoning-check, hardware-synthesis, mu-conservation-check, inquisitor-strict, proof-chain-verification]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# üõ°Ô∏è Adversarial Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Verification Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Zero Admits & Axioms | ${{ needs.zero-admits-axioms.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coq Kernel Build | ${{ needs.coq-kernel-build.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| No Circular Reasoning | ${{ needs.circular-reasoning-check.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Hardware Synthesis | ${{ needs.hardware-synthesis.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Œº-Conservation | ${{ needs.mu-conservation-check.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Inquisitor Quality | ${{ needs.inquisitor-strict.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Proof Chain Integrity | ${{ needs.proof-chain-verification.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.zero-admits-axioms.result }}" == "success" ] && \
             [ "${{ needs.coq-kernel-build.result }}" == "success" ] && \
             [ "${{ needs.circular-reasoning-check.result }}" == "success" ] && \
             [ "${{ needs.hardware-synthesis.result }}" == "success" ] && \
             [ "${{ needs.mu-conservation-check.result }}" == "success" ] && \
             [ "${{ needs.inquisitor-strict.result }}" == "success" ] && \
             [ "${{ needs.proof-chain-verification.result }}" == "success" ]; then
            echo "## ‚úÖ ALL ADVERSARIAL CHECKS PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Repository withstands adversarial verification." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå ADVERSARIAL AUDIT FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more critical checks failed. Review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
