name: Release with Proofs

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-and-prove:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Create dist directory
        run: mkdir -p dist roadmap-enhancements/supply-chain/attestations
      
      - name: Build receipt for kernel
        run: |
          python3 verifier/replay.py bootstrap_receipts --dry-run
          python3 roadmap-enhancements/binary-ingest/ingest_binary.py thiele_min.py --out dist/receipt.json --description "Thiele Machine Kernel"
      
      - name: Generate SLSA provenance
        run: |
          cat > roadmap-enhancements/supply-chain/attestations/slsa-provenance.json << EOF
          {
            "_type": "https://in-toto.io/Statement/v0.1",
            "subject": [
              {
                "name": "receipt.json",
                "digest": {
                  "sha256": "$(sha256sum dist/receipt.json | awk '{print $1}')"
                }
              }
            ],
            "predicateType": "https://slsa.dev/provenance/v1",
            "predicate": {
              "buildDefinition": {
                "buildType": "https://github.com/sethirus/The-Thiele-Machine/BuildType/v1",
                "externalParameters": {
                  "repository": "${{ github.repository }}",
                  "ref": "${{ github.ref }}",
                  "workflow": ".github/workflows/release.yml"
                },
                "internalParameters": {
                  "python_version": "3.12",
                  "build_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
                },
                "resolvedDependencies": [
                  {
                    "uri": "git+https://github.com/${{ github.repository }}@${{ github.sha }}",
                    "digest": {
                      "gitCommit": "${{ github.sha }}"
                    }
                  }
                ]
              },
              "runDetails": {
                "builder": {
                  "id": "https://github.com/actions/runner/github-hosted"
                },
                "metadata": {
                  "invocationId": "${{ github.run_id }}",
                  "startedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
                }
              }
            }
          }
          EOF
      
      - name: Submit to Rekor (dry-run)
        run: |
          python3 roadmap-enhancements/supply-chain/tools/rekor_submit.py dist/receipt.json --out roadmap-enhancements/supply-chain/attestations/TRANSPARENCY.txt --dry-run || true
      
      - name: Build Go verifier
        run: |
          cd roadmap-enhancements/go-verifier/thiele-replay-go
          CGO_ENABLED=0 go build -trimpath -ldflags="-s -w" -o ../../../dist/thiele-replay-go
      
      - name: Create release bundle
        run: |
          cd dist
          tar czf ../thiele-machine-${{ github.ref_name }}.tar.gz *
      
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            dist/receipt.json
            roadmap-enhancements/supply-chain/attestations/slsa-provenance.json
            roadmap-enhancements/supply-chain/attestations/TRANSPARENCY.txt
            dist/thiele-replay-go
            thiele-machine-${{ github.ref_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Print verification commands
        run: |
          echo "========================================"
          echo "Release artifacts created successfully!"
          echo "========================================"
          echo ""
          echo "Verify receipt:"
          echo "  curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/receipt.json"
          echo "  python3 verifier/replay.py receipt.json --verify"
          echo ""
          echo "Verify SLSA provenance:"
          echo "  curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/slsa-provenance.json"
          echo "  # Use cosign verify-attestation (requires Sigstore)"
          echo ""
          echo "Global digest: $(jq -r .global_digest dist/receipt.json)"
