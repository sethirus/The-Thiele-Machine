name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: read

jobs:
  prepare-toolchain:
    name: Prepare toolchain
    runs-on: ubuntu-latest
    outputs:
      coq: ${{ steps.check_tools.outputs.coq }}
      iverilog: ${{ steps.check_tools.outputs.iverilog }}
      yosys: ${{ steps.check_tools.outputs.yosys }}
      ocamlc: ${{ steps.check_tools.outputs.ocamlc }}
    steps:
      - uses: actions/checkout@v4

      - name: Install toolchain packages
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends coq coq-utils coinor-csdp ocaml iverilog yosys

      - name: Write toolchain diagnostics
        run: |
          set -euo pipefail
          echo "Toolchain diagnostics" > toolchain_diagnostics.txt
          echo "Date: $(date -u)" >> toolchain_diagnostics.txt
          echo "PATH=$PATH" >> toolchain_diagnostics.txt
          echo "which coqc: $(command -v coqc || true)" >> toolchain_diagnostics.txt
          echo "coqc --version: $(coqc --version 2>&1 || true)" >> toolchain_diagnostics.txt
          echo "which ocamlc: $(command -v ocamlc || true)" >> toolchain_diagnostics.txt
          echo "ocamlc -vnum: $(ocamlc -vnum 2>&1 || true)" >> toolchain_diagnostics.txt
          echo "which iverilog: $(command -v iverilog || true)" >> toolchain_diagnostics.txt
          echo "iverilog -v: $(iverilog -v 2>&1 || true)" >> toolchain_diagnostics.txt
          echo "which yosys: $(command -v yosys || true)" >> toolchain_diagnostics.txt
          echo "yosys -V: $(yosys -V 2>&1 || true)" >> toolchain_diagnostics.txt
          cat toolchain_diagnostics.txt
      - name: Upload toolchain diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: toolchain-diagnostics
          path: toolchain_diagnostics.txt

      - name: Check tool availability
        id: check_tools
        run: |
          coq=false
          iverilog=false
          yosys=false
          ocamlc=false
          if command -v coqc >/dev/null 2>&1; then coq=true; fi
          if command -v iverilog >/dev/null 2>&1; then iverilog=true; fi
          if command -v yosys >/dev/null 2>&1; then yosys=true; fi
          if command -v ocamlc >/dev/null 2>&1; then ocamlc=true; fi
          echo "coq=$coq" >> $GITHUB_OUTPUT
          echo "iverilog=$iverilog" >> $GITHUB_OUTPUT
          echo "yosys=$yosys" >> $GITHUB_OUTPUT
          echo "ocamlc=$ocamlc" >> $GITHUB_OUTPUT
  tests:
    name: Python tests
    runs-on: ubuntu-latest
    needs: prepare-toolchain
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4

      - name: Install toolchain dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coq coq-utils iverilog

      - name: Download toolchain diagnostics
        uses: actions/download-artifact@v4
        with:
          name: toolchain-diagnostics
          path: ./artifacts/toolchain || true

      - name: Show toolchain diagnostics
        run: |
          if [ -f ./artifacts/toolchain/toolchain_diagnostics.txt ]; then
            sed -n '1,200p' ./artifacts/toolchain/toolchain_diagnostics.txt || true
          else
            echo "No toolchain diagnostics available"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e . --no-deps

      - name: Build Coq extraction and compile extracted runner (optional)
        run: |
          set -e
          # Build extraction IR if Coq sources available
          if [ -d coq ]; then
            make -C coq Extraction.vo || true
          fi
          # Compile extracted OCaml runner if IR present and ocamlc available
          if [ -f build/thiele_core.ml ] && command -v ocamlc >/dev/null 2>&1; then
            ocamlc -I build -o build/extracted_vm_runner \
              build/thiele_core.mli \
              build/thiele_core.ml \
              tools/extracted_vm_runner.ml
          else
            echo "OCaml/Coq artifacts not present or ocamlc missing - skipping extracted runner build"
          fi

      - name: Run pytest
        run: pytest

  proof-audit:
    name: Proof audit (Inquisitor)
    runs-on: ubuntu-latest
    needs: prepare-toolchain
    steps:
      - uses: actions/checkout@v4

      - name: Download toolchain diagnostics
        uses: actions/download-artifact@v4
        with:
          name: toolchain-diagnostics
          path: ./artifacts/toolchain || true

      - name: Show toolchain diagnostics
        run: |
          if [ -f ./artifacts/toolchain/toolchain_diagnostics.txt ]; then
            sed -n '1,200p' ./artifacts/toolchain/toolchain_diagnostics.txt || true
          else
            echo "No toolchain diagnostics available"
          fi

      - name: Install Coq and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coq coq-utils coinor-csdp ocaml

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install audit dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Inquisitor
        run: python scripts/inquisitor.py --report INQUISITOR_REPORT.md

      - name: Upload Inquisitor report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: inquisitor-report
          path: INQUISITOR_REPORT.md

  coq-kernel:
    name: Coq full compile + 3-layer bisimulation
    runs-on: ubuntu-latest
    needs: prepare-toolchain
    steps:
      - uses: actions/checkout@v4

      - name: Download toolchain diagnostics
        uses: actions/download-artifact@v4
        with:
          name: toolchain-diagnostics
          path: ./artifacts/toolchain || true

      - name: Show toolchain diagnostics
        run: |
          if [ -f ./artifacts/toolchain/toolchain_diagnostics.txt ]; then
            sed -n '1,200p' ./artifacts/toolchain/toolchain_diagnostics.txt || true
          else
            echo "No toolchain diagnostics available"
          fi

      - name: Install Coq + OCaml + Verilog tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y coq coq-utils coinor-csdp ocaml iverilog

      - name: Build full Coq proof tree
        run: |
          cd coq
          coq_makefile -f _CoqProject -o Makefile 2>&1 | grep -v "Warning:"
          make -j2

      - name: Extract Coq semantics to OCaml IR
        run: make -C coq Extraction.vo

      - name: Run 3-layer bisimulation tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e . --no-deps
          python -m pytest tests/test_extracted_vm_runner.py tests/test_bisimulation_complete.py tests/test_property_bisimulation.py tests/adversarial_fuzzing.py -v

  dependency-scan:
    name: Dependency scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
      - name: Run pip-audit
        run: |
          # CVE-2025-53000 is a Windows-specific vulnerability (SVG->PDF unsafe search path)
          # and is not applicable to Linux CI runners. Already documented in SECURITY.md.
          pip-audit -r requirements.txt --progress=off --ignore-vuln CVE-2025-53000

  hardware-verification:
    name: Hardware synthesis + simulation
    runs-on: ubuntu-latest
    needs: prepare-toolchain
    steps:
      - uses: actions/checkout@v4

      - name: Download toolchain diagnostics
        uses: actions/download-artifact@v4
        with:
          name: toolchain-diagnostics
          path: ./artifacts/toolchain || true

      - name: Show toolchain diagnostics
        run: |
          if [ -f ./artifacts/toolchain/toolchain_diagnostics.txt ]; then
            sed -n '1,200p' ./artifacts/toolchain/toolchain_diagnostics.txt || true
          else
            echo "No toolchain diagnostics available"
          fi

      - name: Install Verilog + synthesis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y iverilog yosys coq coq-utils coinor-csdp ocaml

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e . --no-deps

      - name: Run forge pipeline (generate Verilog + compile)
        run: bash scripts/forge_artifact.sh

      - name: Synthesize with Yosys
        run: |
          yosys -p "read_verilog -sv -nomem2reg -DSYNTHESIS -DYOSYS_LITE -I thielecpu/hardware/rtl thielecpu/hardware/rtl/thiele_cpu_unified.v; prep; check; stat" > synthesis.log 2>&1

      - name: Simulate hardware
        run: |
          vvp build/thiele_cpu_tb.out +VCD=build/thiele_cpu_tb.vcd > simulation.log 2>&1

      - name: Analyze waveforms
        run: python scripts/analyze_waveforms.py build/thiele_cpu_tb.vcd > waveform_analysis.txt

      - name: Verify synthesis stats
        run: |
          if ! grep -q "Number of cells:" synthesis.log; then
            echo "Synthesis failed - no cell count"
            exit 1
          fi
          echo "Synthesis successful"

      - name: Verify simulation
        run: |
          if ! grep -q "Test completed" simulation.log; then
            echo "Simulation failed"
            exit 1
          fi
          echo "Simulation successful"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hardware-logs
          path: |
            synthesis.log
            simulation.log
            build/thiele_cpu_tb.vcd
            waveform_analysis.txt

  full-verification:
    name: Full automated verification pipeline
    runs-on: ubuntu-latest
    needs: prepare-toolchain
    steps:
      - uses: actions/checkout@v4

      - name: Download toolchain diagnostics
        uses: actions/download-artifact@v4
        with:
          name: toolchain-diagnostics
          path: ./artifacts/toolchain || true

      - name: Show toolchain diagnostics
        run: |
          if [ -f ./artifacts/toolchain/toolchain_diagnostics.txt ]; then
            sed -n '1,200p' ./artifacts/toolchain/toolchain_diagnostics.txt || true
          else
            echo "No toolchain diagnostics available"
          fi

      - name: Install all required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y coq coq-utils coinor-csdp ocaml iverilog yosys

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e . --no-deps

      - name: Run full automated verification
        run: bash scripts/automated_verification.sh

      - name: Upload verification reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-reports
          path: verification_reports/
