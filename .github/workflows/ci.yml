name: Thiele CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  receipt-tests:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      COQBIN: /usr/bin/

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq coq ocaml ocaml-findlib iverilog yosys
          sudo apt-get install -y -qq drat-trim lrat-check || true
          missing_proof_tools=0
          if ! command -v drat-trim >/dev/null || ! command -v lrat-check >/dev/null; then
            bash scripts/install_proof_tools.sh
            missing_proof_tools=1
          fi
          if [ "$missing_proof_tools" -eq 1 ] && (! command -v drat-trim >/dev/null || ! command -v lrat-check >/dev/null); then
            echo "Proof tooling (drat-trim/lrat-check) still missing after install attempts." >&2
            exit 1
          fi

      - name: Verify requirements (no disallowed packages)
        run: python3 scripts/check_requirements.py

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r config/requirements.txt

      - name: Purge optional insecure packages
        run: |
          # Ensure known-flagged packages are not present in the runtime env used by pip-audit
          pip uninstall -y biopython ecdsa nbconvert || true

      - name: Run pip-audit and fail on unexpected vulnerabilities
        run: |
          python3 -m pip install --upgrade pip
          pip install pip-audit
          python3 scripts/check_pip_audit.py

      - name: Compile Coq proofs
        run: make -C coq

      - name: Run Inquisitor (strict)
        run: python3 scripts/inquisitor.py --strict --coq-root coq --report artifacts/INQUISITOR_REPORT.md

      - name: Build Coq extraction IR
        run: make -C coq Extraction.vo

      - name: Compile Coq extracted runner
        run: |
          if [ ! -f build/thiele_core.ml ] || [ ! -f build/thiele_core.mli ]; then
            echo "Missing Coq extraction outputs (build/thiele_core.ml and build/thiele_core.mli). Run: make -C coq Extraction.vo" >&2
            exit 1
          fi
          ocamlc -I build -o build/extracted_vm_runner \
            build/thiele_core.mli \
            build/thiele_core.ml \
            tools/extracted_vm_runner.ml

      - name: Generate extracted opcodes
        run: |
          python3 scripts/forge.py \
            --input build/thiele_core.ml \
            --out-python thielecpu/generated/generated_core.py \
            --out-verilog thielecpu/hardware/rtl/generated_opcodes.vh

      - name: Run full verification suite
        run: python3 scripts/verify_3layer.py

      - name: Run equivalence bundle
        run: python3 scripts/equivalence_bundle.py --out results/equivalence_bundle.json

      - name: Run thermo experiment (evidence strict)
        run: EVIDENCE_STRICT=1 python3 scripts/thermo_experiment.py --out results/thermo_experiment.json

      - name: Compile Verilog
        run: iverilog thielecpu/hardware/rtl/*.v -o thiele_cpu

      - name: Synthesize Verilog (Yosys)
        run: |
          yosys -s scripts/synth_mu_alu.ys
          yosys -s scripts/synth_all_modules.ys

      - name: Run tests (full suite)
        run: pytest -q tests/

      - name: Run strict isomorphism fuzzing
        run: pytest -q tests/adversarial_fuzzing.py
