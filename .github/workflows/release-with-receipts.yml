name: Release with Signed Receipts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  id-token: write

jobs:
  build-and-release-with-receipts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install cryptography  # For Ed25519 signing
      
      - name: Generate Ed25519 signing key (ephemeral for demo)
        run: |
          python3 << 'PYTHON_EOF'
          from cryptography.hazmat.primitives.asymmetric import ed25519
          from cryptography.hazmat.primitives import serialization
          
          # Generate ephemeral key pair for this release
          private_key = ed25519.Ed25519PrivateKey.generate()
          public_key = private_key.public_key()
          
          # Save private key (PEM format)
          with open('release_signing_key.pem', 'wb') as f:
              f.write(private_key.private_bytes(
                  encoding=serialization.Encoding.PEM,
                  format=serialization.PrivateFormat.PKCS8,
                  encryption_algorithm=serialization.NoEncryption()
              ))
          
          # Save public key (PEM format)
          with open('release_public_key.pem', 'wb') as f:
              f.write(public_key.public_bytes(
                  encoding=serialization.Encoding.PEM,
                  format=serialization.PublicFormat.SubjectPublicKeyInfo
              ))
          
          print("✅ Generated ephemeral Ed25519 key pair for release signing")
          print(f"Public key fingerprint: {public_key.public_bytes_raw().hex()[:16]}...")
          PYTHON_EOF
      
      - name: Create dist directory
        run: |
          mkdir -p dist
          mkdir -p release_artifacts
      
      - name: Build Python package
        run: |
          python -m pip install build
          python -m build
          cp dist/*.whl release_artifacts/ || true
          cp dist/*.tar.gz release_artifacts/ || true
      
      - name: Create receipts for release artifacts
        run: |
          # Get tag name
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi
          
          echo "Creating receipts for release: $TAG_NAME"
          
          # Create receipt for each artifact in dist/
          for file in dist/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Creating receipt for: $filename"
              
              python3 create_receipt.py "$file" \
                --output "release_artifacts/${filename}.receipt.json" \
                --sign release_signing_key.pem \
                --public-key release_public_key.pem \
                --metadata "{\"release_tag\":\"$TAG_NAME\",\"commit\":\"${{ github.sha }}\",\"build_date\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"repository\":\"${{ github.repository }}\"}"
            fi
          done
          
          # Copy public key to release artifacts
          cp release_public_key.pem release_artifacts/
          
          echo "✅ Receipts created and signed"
      
      - name: Create verification instructions
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi
          
          cat > release_artifacts/VERIFY.md << 'EOF'
          # Verifying Release ${{ github.ref_name || github.event.inputs.tag_name }}
          
          This release includes cryptographically signed receipts for all artifacts.
          
          ## Browser Verification (Easiest)
          
          1. Visit: https://sethirus.github.io/The-Thiele-Machine/verify.html
          2. Drag and drop any `.receipt.json` file from this release
          3. The verifier will check:
             - Hash chain integrity
             - Global digest
             - Ed25519 signature (if signed)
          4. Download the original artifact and compare SHA-256
          
          ## CLI Verification
          
          ### Option 1: Python verifier
          
          ```bash
          # Clone repository
          git clone https://github.com/${{ github.repository }}.git
          cd The-Thiele-Machine
          
          # Install dependencies
          pip install -e .
          
          # Download release artifacts
          TAG="${TAG_NAME}"
          curl -LO "https://github.com/${{ github.repository }}/releases/download/${TAG}/release_artifacts.zip"
          unzip release_artifacts.zip
          
          # Verify a receipt
          python3 verifier/replay.py release_artifacts/artifact_name.receipt.json --verify
          
          # Check signature with public key
          python3 tools/verify_trs10.py release_artifacts/artifact_name.receipt.json \
            --public-key release_artifacts/release_public_key.pem
          ```
          
          ### Option 2: Quick hash check
          
          ```bash
          # Download artifact and receipt
          curl -LO "https://github.com/${{ github.repository }}/releases/download/${TAG}/artifact_name"
          curl -LO "https://github.com/${{ github.repository }}/releases/download/${TAG}/artifact_name.receipt.json"
          
          # Extract expected digest from receipt
          EXPECTED_DIGEST=$(python3 -c "import json; print(json.load(open('artifact_name.receipt.json'))['global_digest'])")
          
          # Compute actual digest
          ACTUAL_DIGEST=$(sha256sum artifact_name | awk '{print $1}')
          
          # Compare
          if [ "$EXPECTED_DIGEST" = "$ACTUAL_DIGEST" ]; then
            echo "✅ Artifact verified successfully!"
          else
            echo "❌ Verification failed - digest mismatch"
          fi
          ```
          
          ## Public Key Fingerprint
          
          The Ed25519 public key for this release:
          
          ```
          # View fingerprint
          python3 << 'PYTHON'
          from cryptography.hazmat.primitives import serialization
          with open('release_public_key.pem', 'rb') as f:
              public_key = serialization.load_pem_public_key(f.read())
          print(f"Fingerprint: {public_key.public_bytes_raw().hex()}")
          PYTHON
          ```
          
          ## Verification Guarantees
          
          ✅ **Integrity**: Receipts prove artifacts haven't been tampered with  
          ✅ **Authenticity**: Ed25519 signatures prove artifacts came from this build  
          ✅ **Reproducibility**: Same inputs always produce same receipts  
          ✅ **Transparency**: Full hash chain visible in receipts  
          
          ## Questions?
          
          See the [Receipt Guide](https://github.com/${{ github.repository }}/blob/main/docs/RECEIPT_GUIDE.md) or open an issue.
          EOF
          
          # Replace TAG placeholder
          sed -i "s/\${TAG_NAME}/$TAG_NAME/g" release_artifacts/VERIFY.md
      
      - name: Create release bundle
        run: |
          cd release_artifacts
          zip -r ../release_artifacts.zip *
          cd ..
          
          # Create manifest
          cat > release_artifacts/MANIFEST.txt << EOF
          Release Artifacts Manifest
          ==========================
          
          Tag: ${{ github.ref_name || github.event.inputs.tag_name }}
          Commit: ${{ github.sha }}
          Build Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          Files:
          EOF
          
          cd release_artifacts
          ls -lh >> MANIFEST.txt
          cd ..
          
          echo "✅ Release bundle created"
      
      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            release_artifacts.zip
            release_artifacts/VERIFY.md
            release_artifacts/release_public_key.pem
            release_artifacts/MANIFEST.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Print success message
        run: |
          TAG_NAME="${{ github.ref_name || github.event.inputs.tag_name }}"
          echo "=========================================="
          echo "✅ Release $TAG_NAME published with receipts!"
          echo "=========================================="
          echo ""
          echo "Verification options:"
          echo ""
          echo "1. Browser: https://sethirus.github.io/The-Thiele-Machine/verify.html"
          echo "2. CLI: See VERIFY.md in release artifacts"
          echo ""
          echo "Download: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
