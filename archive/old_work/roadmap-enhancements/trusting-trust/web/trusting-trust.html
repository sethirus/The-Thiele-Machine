<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trusting Trust - Live Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .intro {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin-bottom: 30px;
            border-radius: 4px;
        }
        
        .intro h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .upload-box {
            border: 3px dashed #3498db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-box:hover {
            border-color: #2c3e50;
            background: #f8f9fa;
        }
        
        .upload-box.loaded {
            border-color: #27ae60;
            background: #d4edda;
        }
        
        .upload-box.error {
            border-color: #e74c3c;
            background: #f8d7da;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .upload-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .upload-subtitle {
            color: #666;
            font-size: 0.9em;
        }
        
        .file-input {
            display: none;
        }
        
        .receipt-info {
            background: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9em;
            text-align: left;
            display: none;
        }
        
        .digest {
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.05);
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
            margin: 5px 0;
            font-size: 0.85em;
        }
        
        .result {
            margin: 30px 0;
            padding: 25px;
            border-radius: 8px;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 2px solid #c3e6cb;
        }
        
        .result.error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
        }
        
        .result-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .result-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .result.success .result-title {
            color: #155724;
        }
        
        .result.error .result-title {
            color: #721c24;
        }
        
        .result-details {
            margin-top: 15px;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background: #2c3e50;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .comparison-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
        
        .footer a {
            color: #3498db;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Trusting Trust Demo</h1>
        <p class="subtitle">Defeat compiler backdoors with cryptographic receipts</p>
        
        <div class="intro">
            <h3>The Problem</h3>
            <p>Ken Thompson showed that even with source code, you can't trust your compiler‚Äîit could insert backdoors when compiling compilers. This is the "trusting trust" attack.</p>
            <h3 style="margin-top: 15px;">The Solution</h3>
            <p>Build the same compiler with two different toolchains (e.g., GCC and Clang), generate cryptographic receipts for both, and prove they produce byte-identical output. If they match, no toolchain-specific backdoor was inserted.</p>
        </div>
        
        <h2 style="margin: 30px 0 20px 0;">Upload Two Compiler Receipts</h2>
        
        <div class="upload-section">
            <div class="upload-box" id="uploadBox1">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-title">GCC Build Receipt</div>
                <div class="upload-subtitle">toycc compiled with GCC</div>
                <div class="receipt-info" id="info1"></div>
            </div>
            
            <div class="upload-box" id="uploadBox2">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-title">Clang Build Receipt</div>
                <div class="upload-subtitle">toycc compiled with Clang</div>
                <div class="receipt-info" id="info2"></div>
            </div>
        </div>
        
        <input type="file" id="fileInput1" class="file-input" accept=".json">
        <input type="file" id="fileInput2" class="file-input" accept=".json">
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" id="verifyBtn" disabled>üîç Verify Equivalence</button>
        </div>
        
        <div class="result" id="result"></div>
        
        <div class="footer">
            <p>Part of <a href="https://github.com/sethirus/The-Thiele-Machine" target="_blank">The Thiele Machine</a> project</p>
            <p>Cryptographic proof of compiler equivalence ‚Ä¢ Zero trust ‚Ä¢ Only math</p>
        </div>
    </div>
    
    <script>
        let receipt1 = null;
        let receipt2 = null;
        
        const uploadBox1 = document.getElementById('uploadBox1');
        const uploadBox2 = document.getElementById('uploadBox2');
        const fileInput1 = document.getElementById('fileInput1');
        const fileInput2 = document.getElementById('fileInput2');
        const info1 = document.getElementById('info1');
        const info2 = document.getElementById('info2');
        const verifyBtn = document.getElementById('verifyBtn');
        const result = document.getElementById('result');
        
        uploadBox1.addEventListener('click', () => fileInput1.click());
        uploadBox2.addEventListener('click', () => fileInput2.click());
        
        fileInput1.addEventListener('change', (e) => handleFile(e.target.files[0], 1));
        fileInput2.addEventListener('change', (e) => handleFile(e.target.files[0], 2));
        
        // Drag and drop
        [uploadBox1, uploadBox2].forEach((box, idx) => {
            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.style.borderColor = '#2c3e50';
            });
            
            box.addEventListener('dragleave', () => {
                box.style.borderColor = '#3498db';
            });
            
            box.addEventListener('drop', (e) => {
                e.preventDefault();
                box.style.borderColor = '#3498db';
                handleFile(e.dataTransfer.files[0], idx + 1);
            });
        });
        
        async function handleFile(file, receiptNum) {
            if (!file) return;
            
            const box = receiptNum === 1 ? uploadBox1 : uploadBox2;
            const info = receiptNum === 1 ? info1 : info2;
            
            try {
                const text = await file.text();
                const receipt = JSON.parse(text);
                
                if (!receipt.files || !Array.isArray(receipt.files)) {
                    box.classList.add('error');
                    info.innerHTML = '‚ùå Invalid receipt format';
                    info.style.display = 'block';
                    return;
                }
                
                // Store receipt
                if (receiptNum === 1) receipt1 = receipt;
                else receipt2 = receipt;
                
                // Extract binary digest
                const binaryFile = receipt.files.find(f => f.path.includes('toycc'));
                const digest = binaryFile ? binaryFile.content_sha256 : receipt.global_digest;
                
                box.classList.add('loaded');
                box.classList.remove('error');
                info.innerHTML = `
                    <strong>‚úì Loaded</strong><br>
                    Files: ${receipt.files.length}<br>
                    Binary SHA256:<br>
                    <div class="digest">${digest.substring(0, 16)}...</div>
                `;
                info.style.display = 'block';
                
                // Enable verify if both loaded
                if (receipt1 && receipt2) {
                    verifyBtn.disabled = false;
                }
                
            } catch (e) {
                box.classList.add('error');
                info.innerHTML = '‚ùå Failed to parse: ' + e.message;
                info.style.display = 'block';
            }
        }
        
        verifyBtn.addEventListener('click', verifyEquivalence);
        
        function verifyEquivalence() {
            if (!receipt1 || !receipt2) return;
            
            // Find binary files
            const binary1 = receipt1.files.find(f => f.path.includes('toycc'));
            const binary2 = receipt2.files.find(f => f.path.includes('toycc'));
            
            if (!binary1 || !binary2) {
                showResult(false, 'Could not find toycc binary in receipts');
                return;
            }
            
            const sha1 = binary1.content_sha256;
            const sha2 = binary2.content_sha256;
            
            const match = sha1 === sha2;
            
            if (match) {
                showResult(true, sha1, {
                    'GCC Binary': binary1.path,
                    'Clang Binary': binary2.path,
                    'Size (GCC)': binary1.size || 'unknown',
                    'Size (Clang)': binary2.size || 'unknown'
                });
            } else {
                showResult(false, null, {
                    'GCC SHA256': sha1,
                    'Clang SHA256': sha2,
                    'Verdict': 'BINARIES DIFFER - POSSIBLE BACKDOOR!'
                });
            }
        }
        
        function showResult(success, digest, details) {
            result.className = 'result ' + (success ? 'success' : 'error');
            
            let html = `
                <div class="result-icon">${success ? '‚úÖ' : '‚ùå'}</div>
                <div class="result-title">
                    ${success ? 'SUCCESS: Compilers Produced Identical Binaries!' : 'FAILURE: Binaries Differ!'}
                </div>
            `;
            
            if (success && digest) {
                html += `
                    <p>Both GCC and Clang produced byte-identical output, cryptographically proven:</p>
                    <div class="digest">${digest}</div>
                    <p style="margin-top: 15px;"><strong>This proves:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>No compiler-specific backdoor was inserted</li>
                        <li>Both toolchains processed the code identically</li>
                        <li>The source code is the single source of truth</li>
                    </ul>
                `;
            } else {
                html += `
                    <p><strong>Warning:</strong> The two compilers produced different binaries. This could indicate:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>A compiler backdoor (trusting trust attack)</li>
                        <li>Different optimization levels</li>
                        <li>Non-deterministic build settings</li>
                    </ul>
                `;
            }
            
            if (details) {
                html += '<div class="result-details"><table class="comparison-table">';
                for (const [key, value] of Object.entries(details)) {
                    html += `<tr><th>${key}</th><td>${value}</td></tr>`;
                }
                html += '</table></div>';
            }
            
            result.innerHTML = html;
            result.style.display = 'block';
        }
    </script>
</body>
</html>
